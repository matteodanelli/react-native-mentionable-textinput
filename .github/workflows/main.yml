# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the develop branch
  pull_request:
    branches:
      - '*'         # matches every branch that doesn't contain a '/'
      - '*/*'       # matches every branch containing a single '/'
      - '**'        # matches every branch

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 15

    env:
      DEVELOPER_DIR: /Applications/Xcode_13.2.1.app

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 1

    - name: Set XCode Version
      run: sudo xcode-select -s /Applications/Xcode_13.2.1.app

    - name: Node
      uses: actions/setup-node@v1

    - name: Cache Lib
      uses: actions/cache@v1
      id: cacheLib
      with:
        path: node_modules
        key: node-modules-${{ hashFiles('yarn.lock') }}

    - name: Cache App
      uses: actions/cache@v1
      id: cacheApp
      with:
        path: example/node_modules
        key: node-modules-${{ hashFiles('example/yarn.lock') }}

    - name: Rebuild detox
      if: steps.cacheLib.outputs.cache-hit == 'true' || steps.cacheApp.outputs.cache-hit == 'true'
      run: yarn detox clean-framework-cache && yarn detox build-framework-cache

    - name: Install Dependencies Lib
      if: steps.cacheLib.outputs.cache-hit != 'true'
      run: yarn install

    - name: Install Dependencies App
      if: steps.cacheApp.outputs.cache-hit != 'true'
      run: cd example && yarn install --ignore-engines

    - name: Cache Pods
      uses: actions/cache@v1
      id: podcache
      with:
        path: example/ios/Pods
        key: pods-${{ hashFiles('**/Podfile.lock') }}

    - name: Update Pods
      run: gem update cocoapods xcodeproj && cd example && cd ios && pod install --repo-update && cd ..
      shell: bash

    - run: brew tap wix/brew
    - run: brew install applesimutils
    - run: yarn e2e:ios-build
    - run: yarn e2e:ios-test